# 报表功能使用说明

## 功能概述

系统支持自动生成周报表、月报表和年报表，报表数据自动保存一个月后自动清理。

## 报表类型

1. **周报表**：统计指定日期所在周（周一到周日）的设备使用情况
2. **月报表**：统计指定月份（1号到月末）的设备使用情况
3. **年报表**：统计指定年份（1月1日到12月31日）的设备使用情况

## 报表内容

每个报表包含以下统计信息：

- **汇总统计**：
  - 总预约次数
  - 已审批通过数量
  - 总收入（元，仅校外人员）
  - 设备总数
  - 用户总数

- **设备使用统计**：
  - 设备编号、型号
  - 预约次数
  - 使用时长（小时）
  - 使用率（%）
  - 校外收费（元）

- **用户类型统计**：
  - 校内学生预约情况
  - 校内教师预约情况
  - 校外人员预约情况

## 使用方法

### 1. 通过Web界面生成报表（管理员）

1. 登录系统，进入"报表统计"页面
2. 选择报表类型（周报表/月报表/年报表）
3. 输入日期：
   - 周报表：选择日期（格式：YYYY-MM-DD，如 2025-01-10）
   - 月报表：选择月份（格式：YYYY-MM，如 2025-01）
   - 年报表：输入年份（格式：YYYY，如 2025）
4. 点击"生成报表"按钮

### 2. 通过管理命令生成报表

#### 手动生成指定报表

```bash
# 生成周报表
python manage.py generate_reports --type week --date 2025-01-10

# 生成月报表
python manage.py generate_reports --type month --date 2025-01

# 生成年报表
python manage.py generate_reports --type year --date 2025
```

#### 自动生成报表（生成上周、上月、去年的报表）

```bash
python manage.py generate_reports --auto
```

### 3. 清理过期报表

系统会自动清理超过一个月的报表。也可以手动清理：

```bash
# 查看将要删除的报表（不实际删除）
python manage.py cleanup_reports --dry-run

# 实际删除过期报表
python manage.py cleanup_reports
```

## 定时任务设置

建议设置定时任务自动生成报表和清理过期报表：

### Windows（任务计划程序）

创建两个任务：

1. **每日生成报表**（每天凌晨2点执行）：
   ```
   python C:\path\to\manage.py generate_reports --auto
   ```

2. **每日清理过期报表**（每天凌晨3点执行）：
   ```
   python C:\path\to\manage.py cleanup_reports
   ```

### Linux（Crontab）

编辑 crontab：
```bash
crontab -e
```

添加以下行：
```
# 每天凌晨2点自动生成报表
0 2 * * * cd /path/to/project && python manage.py generate_reports --auto

# 每天凌晨3点清理过期报表
0 3 * * * cd /path/to/project && python manage.py cleanup_reports
```

## 权限说明

- **设备管理员**：可以生成和查看所有报表
- **实验室负责人**：只能查看已生成的报表，不能生成新报表

## 报表保存期限

- 报表自动保存**一个月**（30天）
- 超过一个月的报表会被自动清理
- 如需长期保存，请及时导出报表

## 注意事项

1. 生成报表时，系统会检查是否已存在相同时间段的报表，避免重复生成
2. 报表数据基于已审批通过的预约记录
3. 使用率计算基于每天8小时可用时间
4. 每个预约默认使用2小时
