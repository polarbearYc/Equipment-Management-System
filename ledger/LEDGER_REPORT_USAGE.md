# 报表与台账功能使用说明

## 功能概述

系统支持自动生成周报表、月报表和年报表，报表数据自动保存一个月后自动清理。同时，系统还提供了完整的台账管理功能，可以查看和导出各类台账数据。

## 一、报表功能

### 报表类型

1. **周报表**：统计指定日期所在周（周一到周日）的设备使用情况
2. **月报表**：统计指定月份（1号到月末）的设备使用情况
3. **年报表**：统计指定年份（1月1日到12月31日）的设备使用情况
4. **自定义时间段报表**：统计指定起始日期和结束日期之间的设备使用情况

### 报表内容

每个报表包含以下统计信息：

- **汇总统计**：
  - 总预约次数
  - 已审批通过数量
  - 已拒绝数量
  - 待审批数量
  - 总收入（元，仅校外人员）
  - 设备总数
  - 用户总数

- **设备使用统计**：
  - 设备编号、型号
  - 预约次数
  - 使用时长（小时，每个预约默认2小时）
  - 使用率（%，基于每天8小时可用时间）
  - 校外收费（元）

- **用户类型统计**：
  - 校内学生预约情况（预约次数、用户数量）
  - 校内教师预约情况（预约次数、用户数量）
  - 校外人员预约情况（预约次数、用户数量）

- **日期统计**：
  - 按日期统计的预约数量（可用于生成图表）

### 报表生成方式

#### 1. 通过Web界面生成报表

**管理员和负责人都可以生成报表：**

1. 登录系统，进入"报表统计"页面
2. 选择报表类型（周报表/月报表/年报表/自定义时间段报表）
3. 输入日期：
   - **周报表**：选择日期（格式：YYYY-MM-DD，如 2025-01-10）
   - **月报表**：选择月份（格式：YYYY-MM，如 2025-01）
   - **年报表**：输入年份（格式：YYYY，如 2025）
   - **自定义时间段报表**：输入起始日期和结束日期（格式：YYYY-MM-DD）
4. 点击"生成报表"按钮
5. 系统会自动检查是否已存在相同时间段的报表，避免重复生成

#### 2. 通过管理命令生成报表

##### 手动生成指定报表

```bash
# 生成周报表
python manage.py generate_reports --type week --date 2025-01-10

# 生成月报表
python manage.py generate_reports --type month --date 2025-01

# 生成年报表
python manage.py generate_reports --type year --date 2025
```

##### 自动生成报表（生成上周、上月、去年的报表）

系统会在以下时间自动生成报表：
- **周报表**：每周一自动生成上一周的报表
- **月报表**：每月1号自动生成上月的报表
- **年报表**：每年1月1日自动生成上一年的报表

也可以手动触发自动生成：

```bash
python manage.py generate_reports --auto
```

#### 3. 查看和导出报表

- 在"报表统计"页面可以查看所有已生成的报表
- 点击报表名称可以查看详细内容
- 点击"导出报表"按钮可以导出为Excel文件（.xlsx格式）
- 导出的Excel文件包含完整的报表数据，日期格式正确

### 清理过期报表

系统会自动清理超过一个月的报表。也可以手动清理：

```bash
# 查看将要删除的报表（不实际删除）
python manage.py cleanup_reports --dry-run

# 实际删除过期报表
python manage.py cleanup_reports
```

## 二、台账功能

### 台账类型

系统提供以下台账类型，所有台账数据都基于预约记录自动生成：

1. **设备台账**：显示所有设备的基本信息和状态
2. **设备操作历史台账**：记录所有设备的操作历史（借出、归还、维护、维修、报废等）
3. **教师台账**：显示所有申请过设备借用的教师信息及其借用的设备
4. **学生台账**：显示所有申请过设备借用的学生信息及其借用的设备
5. **校外人员台账**：显示所有申请过设备借用的校外人员信息及其借用的设备
6. **预约台账**：显示所有预约申请的详细信息

### 台账功能特点

- **自动生成**：所有台账数据基于预约记录自动生成，无需手动维护
- **实时更新**：当有新的预约审批通过时，相关台账会自动更新
- **完整记录**：设备操作历史台账自动记录所有设备相关操作（新增、修改、删除、借出、归还等）
- **关联查询**：用户台账显示每个用户借用的所有设备编号和借用次数

### 台账查看方式

1. 登录系统（需要管理员或负责人权限）
2. 进入"台账管理"页面
3. 选择要查看的台账类型
4. 使用筛选功能查找特定记录：
   - 设备台账：可按设备编号、型号、厂商、状态筛选
   - 用户台账：可按用户编号、姓名、部门等筛选
   - 预约台账：可按预约编号、设备编号、申请人姓名等筛选
   - 操作历史台账：可按设备编号、操作类型、日期范围、操作员筛选

### 台账导出功能

所有台账都支持导出为Excel文件（.xlsx格式）：

1. 在台账列表页面，点击"导出Excel"按钮
2. 系统会导出当前筛选条件下的所有数据
3. 导出的Excel文件包含：
   - 完整的台账数据
   - 正确的日期格式（Excel会自动识别为日期类型）
   - 自动调整的列宽
   - 格式化的表头

**支持的导出功能：**
- 设备台账导出：`/ledger/device/info/export/csv/`
- 设备操作历史导出：`/ledger/device/operation/export/csv/`
- 教师台账导出：`/ledger/teacher/export/csv/`
- 学生台账导出：`/ledger/student/export/csv/`
- 校外人员台账导出：`/ledger/external/export/csv/`
- 预约台账导出：`/ledger/booking/export/csv/`

### 台账与预约的联动

- **设备台账**：当预约审批通过时，自动创建借出台账记录
- **用户台账**：基于预约记录动态生成，显示每个用户的所有借用记录
- **预约台账**：直接显示所有预约申请，包括审批状态
- **操作历史台账**：记录所有设备操作，包括借出、归还等操作

## 三、定时任务设置

建议设置定时任务自动生成报表和清理过期报表：

### Windows（任务计划程序）

创建两个任务：

1. **每日生成报表**（每天凌晨2点执行）：
   ```
   python C:\path\to\manage.py generate_reports --auto
   ```

2. **每日清理过期报表**（每天凌晨3点执行）：
   ```
   python C:\path\to\manage.py cleanup_reports
   ```

### Linux（Crontab）

编辑 crontab：
```bash
crontab -e
```

添加以下行：
```
# 每天凌晨2点自动生成报表
0 2 * * * cd /path/to/project && python manage.py generate_reports --auto

# 每天凌晨3点清理过期报表
0 3 * * * cd /path/to/project && python manage.py cleanup_reports
```

## 四、权限说明

### 报表权限

- **设备管理员**：可以生成、查看和导出所有报表
- **实验室负责人**：可以生成、查看和导出所有报表

### 台账权限

- **设备管理员**：可以查看和导出所有台账
- **实验室负责人**：可以查看和导出所有台账
- **普通用户**：无权限访问台账模块

## 五、数据保存期限

### 报表保存期限

- 报表自动保存**一个月**（30天）
- 超过一个月的报表会被自动清理
- 如需长期保存，请及时导出报表为Excel文件

### 台账数据保存

- 台账数据永久保存，不会自动清理
- 所有台账记录都是只读的，用于历史追溯
- 建议定期导出重要台账数据作为备份

## 六、注意事项

### 报表注意事项

1. 生成报表时，系统会检查是否已存在相同时间段的报表，避免重复生成
2. 报表数据基于已审批通过的预约记录（status='manager_approved'）
3. 使用率计算基于每天8小时可用时间
4. 每个预约默认使用2小时
5. 校外人员预约才会产生收入统计
6. 自定义时间段报表可以重复生成，不会检查重复

### 台账注意事项

1. 台账数据是只读的，不能直接修改
2. 设备操作历史台账会自动记录所有设备相关操作
3. 用户台账（教师/学生/校外人员）只显示有预约记录的用户
4. 导出的Excel文件中的日期格式已正确设置，Excel会自动识别为日期类型
5. 如果设备被删除，台账记录中的设备信息会保留为快照（device_name字段）

## 七、常见问题

### Q: 为什么我的报表中没有数据？

A: 请检查：
1. 选择的日期范围内是否有预约记录
2. 预约是否已审批通过（只有status='manager_approved'的预约才会统计）
3. 日期格式是否正确

### Q: 台账中的设备信息为什么显示不全？

A: 用户台账（教师/学生/校外人员）只显示有预约记录的用户。如果某个用户从未申请过设备借用，则不会出现在对应的用户台账中。

### Q: 导出的Excel文件日期显示为#####怎么办？

A: 系统已修复此问题，导出的Excel文件中的日期格式已正确设置。如果仍然出现问题，请检查Excel的列宽是否足够显示日期。

### Q: 如何查看某个设备的所有操作历史？

A: 在"设备操作历史台账"页面，使用设备编号筛选功能，输入设备编号即可查看该设备的所有操作记录。

### Q: 报表和台账有什么区别？

A: 
- **报表**：按时间段统计设备使用情况，包含汇总数据、使用率等统计信息，主要用于分析和报告
- **台账**：记录详细的设备、用户和预约信息，主要用于查询和追溯，数据永久保存

### Q: 可以自定义报表的统计内容吗？

A: 目前不支持自定义报表内容，但可以通过导出台账数据后自行分析。如需自定义报表，需要修改代码中的`generate_report_data`函数。

## 八、技术说明

### 报表数据存储

- 报表数据以JSON格式存储在数据库的`Report`模型中
- 包含完整的统计数据和原始数据引用
- 支持快速查询和导出

### 台账数据来源

- 设备台账：直接查询`Device`模型
- 设备操作历史台账：查询`DeviceLedger`模型
- 用户台账：通过`Booking`模型关联查询`UserInfo`模型
- 预约台账：直接查询`Booking`模型

### 导出格式

- 所有导出功能使用`openpyxl`库生成Excel文件（.xlsx格式）
- 日期字段使用`number_format`设置为Excel可识别的日期格式
- 自动调整列宽以适应内容
- 表头使用粗体和对齐格式

## 九、相关文档

- 测试使用说明：请查看 [TESTING.md](TESTING.md)
- 项目总体说明：请查看 [README.md](README.md)
